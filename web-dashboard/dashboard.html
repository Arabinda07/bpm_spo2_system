<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Live Dashboard |YOUR_SCHOOL_NAME</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<!-- Chart.js + Luxon -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/luxon@3"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-luxon"></script>

<style>
body {
  margin: 0;
  font-family: Arial, sans-serif;
  background: #f4f6f8;
  color: #2c3e50;
}

header {
  background: #203a43;
  color: white;
  padding: 12px;
  display: flex;
  align-items: center;
  gap: 12px;
}
header img {
  width: 48px;
  background: white;
  border-radius: 8px;
  padding: 4px;
}
header .title {
  flex: 1;
}
header .status {
  font-size: 12px;
}

.container {
  max-width: 1100px;
  margin: auto;
  padding: 12px;
}

.card {
  background: #ffffff;
  padding: 14px;
  border-radius: 10px;
  margin-bottom: 14px;
  box-shadow: 0 4px 12px rgba(0,0,0,0.06);
}

/* METRICS */
.metrics-row {
  display: flex;
  gap: 16px;
}
.metric-card {
  flex: 1;
  text-align: center;
}

/* SVG ICONS */
.metric-icon {
  width: 32px;
  height: 32px;
  margin: 0 auto 6px;
  color: #203a43;
}
.metric-icon svg {
  width: 100%;
  height: 100%;
  stroke: currentColor;
  fill: none;
  stroke-width: 2;
  stroke-linecap: round;
  stroke-linejoin: round;
}

/* HEARTBEAT ANIMATION */
@keyframes heartbeat-flow {
  0%   { stroke-dashoffset: 60; opacity: 0.7; }
  50%  { opacity: 1; }
  100% { stroke-dashoffset: 0; opacity: 0.7; }
}

.heartbeat-line {
  stroke-dasharray: 60;
  stroke-dashoffset: 60;
  animation: heartbeat-flow 1.8s linear infinite;
}

.heartbeat-fast {
  animation-duration: 1.1s;
}

.heartbeat-paused {
  animation-play-state: paused;
  opacity: 0.4;
}

.metric-value {
  font-size: 40px;
  font-weight: 700;
}
.metric-label {
  font-size: 13px;
  opacity: 0.65;
  color: #555;
}

/* SQI */
.sqi-row {
  margin-top: 10px;
  font-size: 14px;
}
.sqi-badge {
  padding: 4px 10px;
  border-radius: 12px;
  font-weight: bold;
  margin-left: 8px;
}
.sqi-good { background:#d4edda; color:#155724; }
.sqi-fair { background:#fff3cd; color:#856404; }
.sqi-poor { background:#f8d7da; color:#721c24; }

/* INTERPRETATION */
.interpretation {
  background: #f9fafb;
  border-left: 4px solid #3498db;
  padding: 12px;
  border-radius: 6px;
}

/* CHART FIX */
.chart-card {
padding: 10px 14px;
  max-width: 900px;
  margin: auto;
}
.chart-card canvas {
  width: 100% !important;
  height: 280px !important;
}

/* FOOTER */
.footer {
  text-align: center;
  font-size: 12px;
  color: #666;
  margin: 12px;
}
.muted {
  color: #777;
  font-size: 12px;
}

button {
  padding: 8px 12px;
  border: none;
  border-radius: 6px;
  background: #203a43;
  color: white;
  cursor: pointer;
}
</style>
</head>

<body>

<header>
  <img src="logo.png" alt="School Logo">
  <div class="title">
    <strong>YOUR_SCHOOL_NAME</strong><br>
    <span id="status" class="status">Device Not Connected</span><br>
    <span class="status">Date (UTC): <span id="utcDate"></span></span>
  </div>
</header>

<div class="container">

  <div class="card">
    <button onclick="goToTrends()">View Trends</button>
    <button onclick="logout()">Logout</button>
  </div>

  <div class="card">
    <div class="metrics-row">

      <!-- BPM -->
      <div class="metric-card">
        <div class="metric-icon">
          <svg viewBox="0 0 24 24">
            <polyline
              id="heartbeatIcon"
              class="heartbeat-line"
              points="1 12 5 12 8 5 12 19 16 9 19 12 23 12" />
          </svg>
        </div>
        <div class="metric-value" id="bpmValue">--</div>
        <div class="metric-label">Heart Rate (BPM)</div>
      </div>

      <!-- SpO2 -->
      <div class="metric-card">
        <div class="metric-icon">
          <svg viewBox="0 0 24 24">
            <circle cx="12" cy="12" r="9"></circle>
            <text x="12" y="16"
              text-anchor="middle"
              font-size="10"
              fill="currentColor"
              stroke="none">%</text>
          </svg>
        </div>
        <div class="metric-value" id="spo2Value">--</div>
        <div class="metric-label">SpO₂ (%)</div>
      </div>

    </div>

    <div class="sqi-row">
      Signal Quality:
      <span id="sqiBadge" class="sqi-badge">--</span>
    </div>
  </div>

  <div class="card">
    <h4>Live Observation</h4>
    <div id="interpretationText" class="interpretation">
      Waiting for valid live data…
    </div>
  </div>

  <div class="card chart-card"><canvas id="bpmChart"></canvas></div>
  <div class="card chart-card"><canvas id="spo2Chart"></canvas></div>

</div>

<div class="footer">
  <div id="sessionSummary">Waiting for valid live data…</div>
  <div id="sessionTimer" class="muted">Session duration: --:--</div>
  <div id="sessionMeta" class="muted">
    Sessions start automatically when valid live data is received.
  </div>
  Educational prototype · Not a medical device
</div>

<script>
const DEVICE_ID = "esp32_001";
const INACTIVITY_MS = 60000;
const LIVE_GRACE_MS = 60000;

document.getElementById("utcDate").textContent =
  luxon.DateTime.utc().toFormat("dd LLL yyyy");

firebase.initializeApp({
  apiKey: "FIREBASE_API_KEY",
  databaseURL: "FIREBASE_APP_URL"
});
const auth = firebase.auth();
const db = firebase.database();

function makeChart(el, label, color, yCfg) {
  return new Chart(el, {
    type: "line",
    data: { datasets: [{ label, data: [], borderColor: color, pointRadius: 0 }] },
options: {
  parsing: false,
  animation: false,
  maintainAspectRatio: false,

  plugins: {
    legend: {
      labels: {
        usePointStyle: true,
        pointStyle: "circle",
        boxWidth: 6,
        boxHeight: 6,
        padding: 14,
        color: "#333",
        font: {
          size: 12,
          weight: "normal"
        }
      }
    }
  },

  scales: {
  x: {
    type: "time",
    grid: { color: "rgba(0,0,0,0.05)" }
  },
  y: {
    ...yCfg,
    grid: { color: "rgba(0,0,0,0.05)" }
  }
}

}

  });
}

const bpmChart = makeChart(
  document.getElementById("bpmChart"),
  "BPM (Live)",
  "red",
  { suggestedMin: 40, suggestedMax: 160 }
);

const spo2Chart = makeChart(
  document.getElementById("spo2Chart"),
  "SpO₂ (Live)",
  "blue",
  { min: 85, max: 100 }
);

let sessionReadings = [];
let deviceRef = null;

let sessionStartTime = null;
let sessionTimerInterval = null;
let lastLiveDataTime = null;

function startSessionTimer() {
  if (sessionTimerInterval) return;
  sessionStartTime = Date.now();
  sessionTimerInterval = setInterval(() => {
    const e = Date.now() - sessionStartTime;
    const m = Math.floor(e / 60000);
    const s = Math.floor((e % 60000) / 1000);
    document.getElementById("sessionTimer").innerText =
      `Session duration: ${String(m).padStart(2,"0")}:${String(s).padStart(2,"0")}`;
  }, 1000);
}

function stopSessionTimer() {
  clearInterval(sessionTimerInterval);
  sessionTimerInterval = null;
}

function std(arr) {
  const m = arr.reduce((a,b)=>a+b,0)/arr.length;
  return Math.sqrt(arr.reduce((s,x)=>s+(x-m)*(x-m),0)/arr.length);
}

function handleReading(d) {
  if (!d || typeof d.timestamp !== "number") return;
  if (d.sqi < 1) return;
  if (Date.now() - d.timestamp > LIVE_GRACE_MS) return;

  lastLiveDataTime = Date.now();
  sessionReadings.push(d);

  document.getElementById("status").textContent = "Device Connected";
  document.getElementById("status").style.color = "#2ecc71";

  document.getElementById("bpmValue").innerText = d.bpm;
  document.getElementById("spo2Value").innerText = d.spo2;

  const hbIcon = document.getElementById("heartbeatIcon");
  if (hbIcon) {
    hbIcon.classList.remove("heartbeat-paused");
    if (d.bpm > 100) hbIcon.classList.add("heartbeat-fast");
    else hbIcon.classList.remove("heartbeat-fast");
  }

  if (!sessionStartTime) {
    document.getElementById("sessionSummary").innerText = "Live session in progress";
    startSessionTimer();
  }

  if (sessionReadings.length < 3) {
    document.getElementById("interpretationText").innerText =
      "Collecting live observations…";
  }

  document.getElementById("sessionMeta").innerText =
    "Last updated: " + new Date(d.timestamp).toLocaleString("en-IN");

  const badge = document.getElementById("sqiBadge");
  badge.className = "sqi-badge " + (d.sqi === 2 ? "sqi-good" : "sqi-fair");
  badge.innerText = d.sqi === 2 ? "GOOD" : "FAIR";

  bpmChart.data.datasets[0].data.push({ x: d.timestamp, y: d.bpm });
  spo2Chart.data.datasets[0].data.push({ x: d.timestamp, y: d.spo2 });
  bpmChart.update();
  spo2Chart.update();

  if (sessionReadings.length >= 3) {
    const bpmArr = sessionReadings.map(r=>r.bpm);
    const spo2Arr = sessionReadings.map(r=>r.spo2);
    document.getElementById("interpretationText").innerText =
      (std(bpmArr) < 8 ? "Heart rate is stable. " : "Heart rate shows variation. ") +
      (std(spo2Arr) < 2 ? "Oxygen saturation is consistent." : "Oxygen saturation fluctuates.");
  }
}

setInterval(() => {
  if (!sessionStartTime || !lastLiveDataTime) return;
  if (Date.now() - lastLiveDataTime > INACTIVITY_MS) {
    stopSessionTimer();
    sessionStartTime = null;
    lastLiveDataTime = null;

    const hbIcon = document.getElementById("heartbeatIcon");
    if (hbIcon) {
      hbIcon.classList.add("heartbeat-paused");
      hbIcon.classList.remove("heartbeat-fast");
    }

    document.getElementById("sessionSummary").innerText =
      "Session ended (no new data)";
    document.getElementById("sessionMeta").innerText =
      "Waiting for next live session…";
    document.getElementById("sessionTimer").innerText =
      "Session duration: --:--";
  }
}, 5000);

function attachDeviceListeners() {
  deviceRef = db.ref(`raw_readings/${DEVICE_ID}/readings`);
  deviceRef.limitToLast(60).on("child_added", s => handleReading(s.val()));
}

auth.onAuthStateChanged(user => {
  if (!user) {
    if (deviceRef) deviceRef.off();
    window.location.href = "index.html";
  } else {
    attachDeviceListeners();
  }
});

function logout() {
  if (deviceRef) deviceRef.off();
  auth.signOut().then(()=>window.location.href="index.html");
}

function goToTrends() {
  window.location.href = "trends.html";
}
</script>

</body>
</html>
